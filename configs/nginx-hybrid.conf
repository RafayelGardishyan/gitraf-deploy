# gitraf nginx configuration - Hybrid mode
# Replace DOMAIN with your actual domain

events {}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    # HTTP to HTTPS redirect
    server {
        listen 80;
        server_name DOMAIN;

        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        location / {
            return 301 https://$host$request_uri;
        }
    }

    # Main HTTPS server
    server {
        listen 443 ssl;
        server_name DOMAIN;

        ssl_certificate /etc/letsencrypt/live/DOMAIN/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/DOMAIN/privkey.pem;

        client_max_body_size 500m;

        # Git Smart HTTP
        location ~ ^/[^/]+\.git(/.*)?$ {
            # Block push from non-tailnet IPs
            if ($request_uri ~ /git-receive-pack$) {
                set $deny_push 1;
            }
            if ($remote_addr ~ ^100\.(6[4-9]|[7-9][0-9]|1[01][0-9]|12[0-7])\.) {
                set $deny_push 0;
            }

            proxy_pass http://127.0.0.1:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Web UI
        location / {
            proxy_pass http://127.0.0.1:8081;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # Wildcard pages hosting (requires wildcard SSL cert)
    server {
        listen 443 ssl default_server;
        server_name ~^(?<subdomain>.+)\.DOMAIN$;

        ssl_certificate /etc/letsencrypt/live/DOMAIN-wildcard/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/DOMAIN-wildcard/privkey.pem;

        root /opt/ogit/pages/$subdomain/site;
        index index.html index.htm;

        location / {
            try_files $uri $uri/ $uri.html =404;
        }

        error_page 404 /404.html;

        location = /robots.txt {
            try_files $uri @default_robots;
        }

        location @default_robots {
            return 200 "User-agent: *\nDisallow: /\n";
            add_header Content-Type text/plain;
        }
    }
}
